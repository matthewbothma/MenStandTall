name: Update Dashboard

on:
  workflow_run:
    workflows: ["CI Pipeline", "CD Pipeline", "PR Validation"]
    types:
      - completed
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Generate Dashboard
      run: |
        cat << 'EOF' > CICD-DASHBOARD.md
        # ?? CI/CD Pipeline Dashboard
        
        Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ## ?? Pipeline Status
        
        | Pipeline | Status | Last Run |
        |----------|--------|----------|
        | CI Pipeline | [![CI](https://github.com/matthewbothma/MenStandTall/actions/workflows/ci.yml/badge.svg)](https://github.com/matthewbothma/MenStandTall/actions/workflows/ci.yml) | [View Runs](https://github.com/matthewbothma/MenStandTall/actions/workflows/ci.yml) |
        | CD Pipeline | [![CD](https://github.com/matthewbothma/MenStandTall/actions/workflows/cd.yml/badge.svg)](https://github.com/matthewbothma/MenStandTall/actions/workflows/cd.yml) | [View Runs](https://github.com/matthewbothma/MenStandTall/actions/workflows/cd.yml) |
        | PR Validation | [![PR](https://github.com/matthewbothma/MenStandTall/actions/workflows/pr-validation.yml/badge.svg)](https://github.com/matthewbothma/MenStandTall/actions/workflows/pr-validation.yml) | [View Runs](https://github.com/matthewbothma/MenStandTall/actions/workflows/pr-validation.yml) |
        
        ## ?? Quick Links
        
        - [All Workflows](https://github.com/matthewbothma/MenStandTall/actions)
        - [Recent Builds](https://github.com/matthewbothma/MenStandTall/actions?query=branch%3Amain)
        - [Failed Runs](https://github.com/matthewbothma/MenStandTall/actions?query=is%3Afailure)
        - [Dependencies](https://github.com/matthewbothma/MenStandTall/network/dependencies)
        
        ## ?? Latest Artifacts
        
        Download the latest build artifacts from the [Actions page](https://github.com/matthewbothma/MenStandTall/actions).
        
        ## ?? Metrics
        
        - **Build Configuration**: Release
        - **Target Framework**: .NET 8.0
        - **Test Framework**: xUnit/NUnit/MSTest
        - **Artifact Retention**: 30 days (builds), 90 days (deployments)
        
        ## ?? Security
        
        - Dependabot: ? Enabled
        - Vulnerability Scanning: ? Enabled
        - Code Scanning: Available (can be enabled)
        
        ## ?? Recent Activity
        
        View detailed activity in the [Actions tab](https://github.com/matthewbothma/MenStandTall/actions).
        
        ---
        
        *This dashboard is automatically updated every 6 hours and after each workflow run.*
        EOF
      
    - name: Commit Dashboard
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add CICD-DASHBOARD.md
        git diff --quiet && git diff --staged --quiet || git commit -m "ci: Update CI/CD dashboard [skip ci]"
        git push
      continue-on-error: true
