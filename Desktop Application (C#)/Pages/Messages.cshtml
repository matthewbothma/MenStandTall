@page
@model Wilproject.Pages.MessagesModel
@{
    ViewData["Title"] = "Messages";
}

<link rel="stylesheet" href="~/css/messages.css" asp-append-version="true" />

<!-- Messages Header -->
<div class="messages-header">
    <div class="messages-header-content">
        <h1 class="messages-title"><i class="fas fa-comments"></i> Messages</h1>
        <p class="messages-subtitle">Communicate with your team and manage announcements</p>
    </div>
</div>

<!-- Message Statistics -->
<div class="message-stats">
    <div class="message-stat-card total">
        <div class="stat-number" id="total-messages">0</div>
        <div class="stat-label">Total Messages</div>
    </div>
    <div class="message-stat-card unread">
        <div class="stat-number" id="unread-messages">0</div>
        <div class="stat-label">Unread</div>
    </div>
    <div class="message-stat-card sent">
        <div class="stat-number" id="sent-messages">0</div>
        <div class="stat-label">Sent</div>
    </div>
    <div class="message-stat-card draft">
        <div class="stat-number" id="draft-messages">0</div>
        <div class="stat-label">Drafts</div>
    </div>
</div>

<!-- Main Messages Container -->
<div class="messages-container">
    <!-- Compose Message Card -->
    <div class="message-card compose-card">
        <div class="card-header-modern">
            <h3 class="card-title"><i class="fas fa-edit"></i> Compose Message</h3>
            <p class="card-subtitle">Create a new message or announcement</p>
        </div>

        <form id="messageForm">
            <!-- Message Title -->
            <div class="form-floating">
                <input type="text" id="MessageTitle" class="form-control" placeholder="Message Title" required />
                <label for="MessageTitle"><i class="fas fa-heading"></i> Message Title</label>
            </div>

            <!-- Message Content -->
            <div class="form-floating">
                <textarea id="MessageContent" class="form-control" placeholder="Write your message here..." 
                          style="height: 150px;" required></textarea>
                <label for="MessageContent"><i class="fas fa-pen"></i> Message Content</label>
            </div>

            <!-- Priority and Category Row -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        <select id="Priority" class="form-control" required>
                            <option value="">-- Select Priority --</option>
                            <option value="High">High Priority</option>
                            <option value="Medium" selected>Medium Priority</option>
                            <option value="Low">Low Priority</option>
                        </select>
                        <label for="Priority"><i class="fas fa-exclamation-circle"></i> Priority Level</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <select id="Category" class="form-control">
                            <option value="announcement">Announcement</option>
                            <option value="meeting">Meeting</option>
                            <option value="project">Project Update</option>
                            <option value="general" selected>General</option>
                        </select>
                        <label for="Category"><i class="fas fa-tags"></i> Category</label>
                    </div>
                </div>
            </div>

            <!-- Tags Input -->
            <div class="form-floating">
                <input type="text" id="MessageTags" class="form-control" placeholder="Tags (comma separated)" />
                <label for="MessageTags"><i class="fas fa-hashtag"></i> Tags (optional, comma separated)</label>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
                <button type="reset" class="btn-modern-message btn-clear">
                    Clear
                </button>
                <button type="button" class="btn-modern-message btn-clear" id="saveDraftBtn">
                    Save Draft
                </button>
                <button type="submit" class="btn-modern-message btn-send">
                    Send Message
                </button>
            </div>
        </form>
    </div>

    <!-- Messages List Card -->
    <div class="message-card messages-list-card">
        <div class="card-header-modern">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h3 class="card-title"><i class="fas fa-inbox"></i> Recent Messages</h3>
                    <p class="card-subtitle">View and manage your messages</p>
                </div>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <!-- Search Messages -->
                    <div class="message-search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="messageSearchInput" placeholder="Search messages..." />
                    </div>
                    
                    <!-- Filter by Category -->
                    <select id="categoryFilter" class="filter-select-small">
                        <option value="all">All Categories</option>
                        <option value="announcement">Announcements</option>
                        <option value="meeting">Meetings</option>
                        <option value="project">Projects</option>
                        <option value="general">General</option>
                    </select>
                    
                    <!-- Filter by Status -->
                    <select id="statusFilter" class="filter-select-small">
                        <option value="all">All Messages</option>
                        <option value="unread">Unread Only</option>
                        <option value="sent">Sent Only</option>
                        <option value="received">Received Only</option>
                        <option value="starred">Starred Only</option>
                    </select>
                    
                    <button class="btn-modern-message btn-secondary" onclick="refreshMessages()" id="refreshMessagesBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-messages" id="loadingMessages">
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                <h5>Loading Messages...</h5>
                <p class="text-muted">Please wait while we fetch your messages.</p>
            </div>
        </div>

        <!-- Messages List -->
        <div class="messages-list" id="messagesList" style="display: none;">
            <!-- Messages will be loaded here dynamically -->
        </div>

        <!-- Empty State -->
        <div class="empty-messages" id="emptyMessages" style="display: none;">
            <div class="text-center py-5">
                <div class="empty-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h4>No Messages Yet</h4>
                <p>Start a conversation by sending your first message!</p>
                <button class="btn-modern-message btn-send" onclick="focusMessageForm()">
                    <i class="fas fa-edit"></i> Compose Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade modal-modern" id="messageDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope-open"></i>
                    Message Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageDetailsBody">
                <!-- Message details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn-modern-message btn-send" id="replyMessageBtn">
                    <i class="fas fa-reply"></i> Reply
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        console.log('💬 Messages script starting...');
        
        var currentUser = null;
        var messages = [];
        var db = null;
        var drafts = [];
        var messagesListener = null;
        var filteredMessages = [];
        var currentMessageId = null;
        var starredMessageIds = new Set();
        
        // Wait for global Firebase to be ready
        function waitForMessagesFirebase(callback) {
            if (window.firebaseAuth && window.firebaseDB) {
                callback();
            } else {
                setTimeout(function() { waitForMessagesFirebase(callback); }, 100);
            }
        }
        
        // Setup messages-specific functionality
        function setupMessages() {
            console.log('💬 Setting up messages');
            
            if (!window.firebaseAuth || !window.firebaseDB) {
                console.error('❌ Firebase not available in messages');
                return;
            }
            
            db = window.firebaseDB;
            
            // Authentication check for messages
            window.firebaseAuth.onAuthStateChanged(function(user) {
                if (!user) {
                    console.log('❌ No user in messages, redirecting');
                    window.location.href = '/';
                } else {
                    currentUser = user;
                    console.log('✅ Messages user authenticated:', user.email);
                    setupMessageHandlers();
                    loadMessagesFromFirebase();
                    loadDraftsFromStorage();
                    loadStarredMessages();
                    setupRealtimeListeners();
                }
            });
        }
        
        // Setup real-time listeners for messages
        function setupRealtimeListeners() {
            if (!db || !currentUser) return;
            
            console.log('🔄 Setting up real-time message listeners');
            
            // Listen to ALL messages (not just current user's)
            messagesListener = db.collection('messages')
                .onSnapshot(function(snapshot) {
                    console.log('🔔 Real-time update received:', snapshot.size, 'messages');
                    
                    snapshot.docChanges().forEach(function(change) {
                        if (change.type === 'added') {
                            console.log('➕ New message:', change.doc.id);
                        }
                        if (change.type === 'modified') {
                            console.log('✏️ Message modified:', change.doc.id);
                        }
                        if (change.type === 'removed') {
                            console.log('🗑️ Message removed:', change.doc.id);
                        }
                    });
                    
                    // Reload all messages
                    loadMessagesFromFirebase();
                }, function(error) {
                    console.error('❌ Real-time listener error:', error);
                    // If listener fails, still try to load messages once
                    loadMessagesFromFirebase();
                });
        }
        
        // Load messages from Firebase
        async function loadMessagesFromFirebase() {
            if (!db || !currentUser) {
                console.error('❌ Cannot load messages: db or currentUser is null');
                return;
            }
            
            showLoadingState(true);
            console.log('📥 Loading ALL messages for all users');
            
            try {
                // Get ALL messages - visible to everyone
                const allMessagesSnapshot = await db.collection('messages')
                    .get();
                
                console.log('📨 Messages query returned:', allMessagesSnapshot.size, 'documents');
                
                // Convert to array and mark as sent or received
                const allMessages = allMessagesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        type: data.authorId === currentUser.uid ? 'sent' : 'received'
                    };
                });
                
                console.log('✅ Processed messages:', allMessages);
                
                messages = allMessages;
                
                // Sort by timestamp (client-side) - most recent first
                messages.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA;
                });
                
                console.log('✅ Total messages loaded:', messages.length);
                console.log('📋 Messages array:', messages);
                
                applyFilters();
                updateMessageStats();
                
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                console.error('Error details:', error.message);
                showNotification('❌ Error loading messages: ' + error.message, 'error');
                
                // Show empty state on error
                showEmptyState();
            } finally {
                showLoadingState(false);
            }
        }
        
        // Apply search and filters
        function applyFilters() {
            const searchTerm = document.getElementById('messageSearchInput')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            console.log('🔍 Applying filters...');
            console.log('Search term:', searchTerm);
            console.log('Category filter:', categoryFilter);
            console.log('Status filter:', statusFilter);
            console.log('Total messages before filter:', messages.length);
            
            // Ensure messages is an array
            if (!Array.isArray(messages)) {
                console.warn('⚠️ Messages is not an array, initializing as empty array');
                messages = [];
            }
            
            filteredMessages = messages.filter(msg => {
                // Ensure message has required properties
                if (!msg || !msg.title || !msg.content) {
                    console.warn('⚠️ Invalid message object:', msg);
                    return false;
                }
                
                // Search filter
                const matchesSearch = !searchTerm || 
                    msg.title.toLowerCase().includes(searchTerm) ||
                    msg.content.toLowerCase().includes(searchTerm) ||
                    (msg.tags && Array.isArray(msg.tags) && msg.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                
                // Category filter
                const matchesCategory = categoryFilter === 'all' || msg.category === categoryFilter;
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'unread') {
                    matchesStatus = !msg.read && msg.type === 'received';
                } else if (statusFilter === 'sent') {
                    matchesStatus = msg.type === 'sent';
                } else if (statusFilter === 'received') {
                    matchesStatus = msg.type === 'received';
                } else if (statusFilter === 'starred') {
                    matchesStatus = starredMessageIds.has(msg.id);
                }
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            console.log('✅ Filtered messages:', filteredMessages.length);
            console.log('📋 Filtered messages array:', filteredMessages);
            
            renderMessages();
        }
        
        // Setup message form handlers
        function setupMessageHandlers() {
            const form = document.getElementById('messageForm');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const searchInput = document.getElementById('messageSearchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // Send message form submission
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await sendMessage();
                });
            }
            
            // Save draft functionality
            if (saveDraftBtn) {
                saveDraftBtn.addEventListener('click', function() {
                    saveDraft();
                });
            }
            
            // Search and filter handlers
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', applyFilters);
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }
            
            // Auto-save draft periodically
            setInterval(autoSaveDraft, 30000); // Every 30 seconds
        }
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Send message
        async function sendMessage() {
            const title = document.getElementById('MessageTitle').value.trim();
            const content = document.getElementById('MessageContent').value.trim();
            const priority = document.getElementById('Priority').value;
            const category = document.getElementById('Category').value;
            const tagsInput = document.getElementById('MessageTags').value.trim();
            
            console.log('📤 Attempting to send message...');
            console.log('Title:', title);
            console.log('Content:', content);
            console.log('Priority:', priority);
            console.log('Category:', category);
            
            if (!title || !content || !priority) {
                showNotification('⚠️ Please fill in all required fields.', 'warning');
                return;
            }
            
            if (!currentUser) {
                console.error('❌ No current user!');
                showNotification('❌ User not authenticated', 'error');
                return;
            }
            
            if (!db) {
                console.error('❌ Database not initialized!');
                showNotification('❌ Database not available', 'error');
                return;
            }
            
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            const messageData = {
                title: title,
                content: content,
                priority: priority,
                category: category,
                tags: tags,
                timestamp: new Date().toISOString(),
                authorId: currentUser.uid,
                authorEmail: currentUser.email,
                authorName: currentUser.displayName || currentUser.email,
                status: 'sent',
                read: false,
                recipientIds: [], // Can be extended for team messaging
                replies: [],
                replyCount: 0
            };
            
            console.log('📦 Message data to send:', messageData);
            
            try {
                console.log('🔄 Adding message to Firebase...');
                const docRef = await db.collection('messages').add(messageData);
                console.log('✅ Message sent with ID:', docRef.id);
                console.log('✅ Message successfully added to Firebase!');
                
                showNotification('✅ Message sent successfully!', 'success');
                
                // Clear form
                document.getElementById('messageForm').reset();
                console.log('🧹 Form cleared');
                
                // Remove any saved draft
                clearDraft();
                
                // Manually reload messages immediately to show the new message
                console.log('🔄 Manually reloading messages...');
                setTimeout(() => {
                    loadMessagesFromFirebase();
                }, 500); // Small delay to ensure Firebase has processed
                
            } catch (error) {
                console.error('❌ Error sending message:', error);
                console.error('Error details:', error.message);
                console.error('Error code:', error.code);
                showNotification('❌ Error sending message: ' + error.message, 'error');
            }
        }
        
        // Save draft
        function saveDraft() {
            const title = document.getElementById('MessageTitle').value.trim();
            const content = document.getElementById('MessageContent').value.trim();
            const priority = document.getElementById('Priority').value;
            const category = document.getElementById('Category').value;
            const tagsInput = document.getElementById('MessageTags').value.trim();
            
            if (!title && !content) {
                showNotification('⚠️ Nothing to save as draft.', 'warning');
                return;
            }
            
            const draft = {
                title: title,
                content: content,
                priority: priority,
                category: category,
                tags: tagsInput,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('messageDraft', JSON.stringify(draft));
            showNotification('💾 Draft saved successfully!', 'info');
            updateDraftCount();
        }
        
        // Auto-save draft
        function autoSaveDraft() {
            const title = document.getElementById('MessageTitle')?.value.trim();
            const content = document.getElementById('MessageContent')?.value.trim();
            
            if (title || content) {
                const draft = {
                    title: title || '',
                    content: content || '',
                    priority: document.getElementById('Priority')?.value || 'Medium',
                    category: document.getElementById('Category')?.value || 'general',
                    tags: document.getElementById('MessageTags')?.value.trim() || '',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('messageDraft', JSON.stringify(draft));
                console.log('💾 Auto-saved draft');
            }
        }
        
        // Load drafts from storage
        function loadDraftsFromStorage() {
            const savedDraft = localStorage.getItem('messageDraft');
            if (savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    
                    // Check if draft is recent (within 24 hours)
                    const draftTime = new Date(draft.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - draftTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        localStorage.removeItem('messageDraft');
                        console.log('🗑️ Old draft removed');
                        return;
                    }
                    
                    // Populate form with draft if user wants
                    if (confirm('You have a saved draft from ' + getTimeAgo(draftTime) + '. Would you like to load it?')) {
                        document.getElementById('MessageTitle').value = draft.title || '';
                        document.getElementById('MessageContent').value = draft.content || '';
                        document.getElementById('Priority').value = draft.priority || 'Medium';
                        document.getElementById('Category').value = draft.category || 'general';
                        document.getElementById('MessageTags').value = draft.tags || '';
                        showNotification('📝 Draft loaded successfully!', 'info');
                    }
                    
                    drafts = [draft];
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
            updateDraftCount();
        }
        
        // Clear draft
        function clearDraft() {
            localStorage.removeItem('messageDraft');
            drafts = [];
            updateDraftCount();
        }
        
        // Update draft count
        function updateDraftCount() {
            document.getElementById('draft-messages').textContent = drafts.length;
        }
        
        // Render messages
        function renderMessages() {
            const messagesList = document.getElementById('messagesList');
            const emptyState = document.getElementById('emptyMessages');
            
            console.log('🎨 Rendering messages...');
            console.log('Filtered messages to render:', filteredMessages.length);
            console.log('Total messages:', messages.length);
            
            if (filteredMessages.length === 0) {
                console.log('📭 No filtered messages to display');
                messagesList.style.display = 'none';
                if (messages.length === 0) {
                    console.log('📭 No messages at all - showing empty state');
                    showEmptyState();
                } else {
                    // Show "no results" message for filters
                    console.log('🔍 Messages exist but none match filters');
                    messagesList.style.display = 'block';
                    messagesList.innerHTML = '<div class="text-center py-5"><i class="fas fa-filter fa-3x text-muted mb-3"></i><h5>No messages match your filters</h5><p class="text-muted">Try adjusting your search or filter settings.</p></div>';
                }
                return;
            }
            
            console.log('✅ Rendering', filteredMessages.length, 'messages');
            if (emptyState) emptyState.style.display = 'none';
            messagesList.style.display = 'block';
            messagesList.innerHTML = '';
            
            filteredMessages.forEach((message, index) => {
                console.log(`📝 Rendering message ${index + 1}:`, message.title);
                const messageDiv = createMessageElement(message);
                messagesList.appendChild(messageDiv);
            });
            
            console.log('✅ All messages rendered successfully');
            animateMessages();
        }
        
        // Create message element
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            const isUnread = !message.read && message.type === 'received';
            const isStarred = starredMessageIds.has(message.id);
            
            messageDiv.className = `message-item priority-${message.priority.toLowerCase()} ${message.type} ${isUnread ? 'unread' : ''} ${isStarred ? 'starred' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);
            
            const timeAgo = getTimeAgo(new Date(message.timestamp));
            const categoryIcon = getCategoryIcon(message.category);
            const typeIcon = message.type === 'sent' ? '<i class="fas fa-paper-plane"></i>' : '<i class="fas fa-inbox"></i>';
            
            // Truncate content for preview
            const contentPreview = message.content.length > 150 ? message.content.substring(0, 150) + '...' : message.content;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                        ${isUnread ? '<span class="unread-indicator" title="Unread"></span>' : ''}
                        <h6 class="message-title mb-0">${typeIcon} ${categoryIcon} ${escapeHtml(message.title)}</h6>
                    </div>
                    <span class="message-priority priority-${message.priority.toLowerCase()}">${message.priority}</span>
                </div>
                <div class="message-content">${escapeHtml(contentPreview)}</div>
                ${message.tags && message.tags.length > 0 ? `
                    <div class="message-tags">
                        ${message.tags.map(tag => `<span class="message-tag"><i class="fas fa-hashtag"></i>${escapeHtml(tag)}</span>`).join('')}
                    </div>
                ` : ''}
                <div class="message-meta">
                    <div class="message-author">
                        <i class="fas fa-user"></i>
                        <span>${message.type === 'sent' ? 'You' : escapeHtml(message.authorName)}</span>
                    </div>
                    <div class="message-time">
                        <i class="fas fa-clock"></i>
                        <span>${timeAgo}</span>
                    </div>
                    ${message.replyCount > 0 ? `
                        <div class="message-replies">
                            <i class="fas fa-comments"></i>
                            <span>${message.replyCount} ${message.replyCount === 1 ? 'reply' : 'replies'}</span>
                        </div>
                    ` : ''}
                    <div class="message-actions">
                        <button class="message-action" onclick="viewMessage('${message.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${message.type === 'received' ? `
                            <button class="message-action ${isUnread ? '' : 'text-muted'}" onclick="toggleRead('${message.id}')" title="${isUnread ? 'Mark as Read' : 'Mark as Unread'}">
                                <i class="fas fa-envelope${isUnread ? '-open' : ''}"></i>
                            </button>
                        ` : ''}
                        <button class="message-action" onclick="replyToMessage('${message.id}')" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                        <button class="message-action ${isStarred ? 'starred' : ''}" onclick="toggleStar('${message.id}')" title="${isStarred ? 'Unstar' : 'Star'}">
                            <i class="fa${isStarred ? 's' : 'r'} fa-star"></i>
                        </button>
                        <button class="message-action text-danger" onclick="deleteMessage('${message.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Make entire card clickable to view
            messageDiv.style.cursor = 'pointer';
            messageDiv.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (!e.target.closest('.message-action')) {
                    viewMessage(message.id);
                }
            });
            
            return messageDiv;
        }
        
        // Message actions
        async function viewMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            currentMessageId = messageId;
            
            // Mark as read if unread
            if (!message.read && message.type === 'received') {
                await markAsRead(messageId);
            }
            
            const modal = document.getElementById('messageDetailsModal');
            const body = document.getElementById('messageDetailsBody');
            
            const timeAgo = getTimeAgo(new Date(message.timestamp));
            const categoryIcon = getCategoryIcon(message.category);
            const isStarred = starredMessageIds.has(message.id);
            
            body.innerHTML = `
                <div class="message-details">
                    <div class="message-detail-header">
                        <h4>${categoryIcon} ${escapeHtml(message.title)}</h4>
                        <div class="d-flex gap-2">
                            <span class="badge bg-${getPriorityColor(message.priority)}">${message.priority} Priority</span>
                            ${isStarred ? '<span class="badge bg-warning"><i class="fas fa-star"></i> Starred</span>' : ''}
                        </div>
                    </div>
                    <div class="message-detail-meta">
                        <div><strong>From:</strong> ${escapeHtml(message.authorName)} (${escapeHtml(message.authorEmail)})</div>
                        <div><strong>Category:</strong> ${message.category}</div>
                        <div><strong>Sent:</strong> ${timeAgo}</div>
                        ${message.tags && message.tags.length > 0 ? `
                            <div><strong>Tags:</strong> ${message.tags.map(tag => `<span class="badge bg-secondary">${escapeHtml(tag)}</span>`).join(' ')}</div>
                        ` : ''}
                    </div>
                    <div class="message-detail-content">
                        <h6>Message:</h6>
                        <p style="white-space: pre-wrap;">${escapeHtml(message.content)}</p>
                    </div>
                    ${message.replies && message.replies.length > 0 ? `
                        <div class="message-replies-section">
                            <h6><i class="fas fa-comments"></i> Replies (${message.replies.length})</h6>
                            ${message.replies.map(reply => `
                                <div class="reply-item">
                                    <div class="reply-header">
                                        <strong>${escapeHtml(reply.authorName)}</strong>
                                        <span class="text-muted">${getTimeAgo(new Date(reply.timestamp))}</span>
                                    </div>
                                    <p>${escapeHtml(reply.content)}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
        
        async function replyToMessage(messageId) {
            if (messageId) {
                currentMessageId = messageId;
            }
            
            const message = messages.find(m => m.id === (messageId || currentMessageId));
            if (!message) return;
            
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('messageDetailsModal'));
            if (modal) modal.hide();
            
            // Pre-fill form with reply
            document.getElementById('MessageTitle').value = `Re: ${message.title}`;
            document.getElementById('MessageContent').value = `\n\n--- Original Message ---\nFrom: ${message.authorName}\nDate: ${new Date(message.timestamp).toLocaleString()}\n\n${message.content}`;
            document.getElementById('Priority').value = message.priority;
            document.getElementById('Category').value = message.category;
            
            // Focus on message content
            const contentField = document.getElementById('MessageContent');
            contentField.focus();
            contentField.setSelectionRange(0, 0);
            
            // Scroll to form
            document.querySelector('.compose-card').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('📝 Reply template loaded', 'info');
        }
        
        async function toggleStar(messageId) {
            if (starredMessageIds.has(messageId)) {
                starredMessageIds.delete(messageId);
                showNotification('⭐ Message unstarred', 'info');
            } else {
                starredMessageIds.add(messageId);
                showNotification('⭐ Message starred', 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('starredMessages', JSON.stringify(Array.from(starredMessageIds)));
            
            // Re-render messages
            applyFilters();
        }
        
        async function toggleRead(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            const newReadStatus = !message.read;
            
            try {
                await db.collection('messages').doc(messageId).update({
                    read: newReadStatus
                });
                
                message.read = newReadStatus;
                showNotification(newReadStatus ? '✅ Marked as read' : '📬 Marked as unread', 'info');
                
                // Messages will auto-update via real-time listener
                
            } catch (error) {
                console.error('Error toggling read status:', error);
                showNotification('❌ Error updating message', 'error');
            }
        }
        
        async function markAsRead(messageId) {
            try {
                await db.collection('messages').doc(messageId).update({
                    read: true
                });
                
                const message = messages.find(m => m.id === messageId);
                if (message) message.read = true;
                
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }
        
        async function deleteMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            if (!confirm(`Are you sure you want to delete "${message.title}"?`)) {
                return;
            }
            
            try {
                await db.collection('messages').doc(messageId).delete();
                showNotification('🗑️ Message deleted successfully!', 'success');
                
                // Messages will auto-update via real-time listener
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('❌ Error deleting message', 'error');
            }
        }
        
        // Load starred messages
        function loadStarredMessages() {
            const starred = localStorage.getItem('starredMessages');
            if (starred) {
                try {
                    const starredArray = JSON.parse(starred);
                    starredMessageIds = new Set(starredArray);
                } catch (error) {
                    console.error('Error loading starred messages:', error);
                }
            }
        }
        
        // Utility functions
        function getCategoryIcon(category) {
            const icons = {
                'announcement': '<i class="fas fa-bullhorn"></i>',
                'meeting': '<i class="fas fa-handshake"></i>',
                'project': '<i class="fas fa-chart-bar"></i>',
                'general': '<i class="fas fa-comment"></i>'
            };
            return icons[category] || '<i class="fas fa-comment"></i>';
        }
        
        function getPriorityColor(priority) {
            const colors = {
                'High': 'danger',
                'Medium': 'warning',
                'Low': 'success'
            };
            return colors[priority] || 'secondary';
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) return `${diffInMinutes} min ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            
            if (diffInDays < 30) {
                const weeks = Math.floor(diffInDays / 7);
                return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
            }
            
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Update message statistics
        function updateMessageStats() {
            const sentMessages = messages.filter(m => m.type === 'sent');
            const unreadMessages = messages.filter(m => !m.read && m.type === 'received');
            
            document.getElementById('total-messages').textContent = messages.length;
            document.getElementById('unread-messages').textContent = unreadMessages.length;
            document.getElementById('sent-messages').textContent = sentMessages.length;
        }
        
        // UI state functions
        function showLoadingState(show) {
            const loading = document.getElementById('loadingMessages');
            const messagesList = document.getElementById('messagesList');
            const emptyState = document.getElementById('emptyMessages');
            
            if (show) {
                loading.style.display = 'block';
                messagesList.style.display = 'none';
                emptyState.style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }
        
        function showEmptyState() {
            const loading = document.getElementById('loadingMessages');
            const messagesList = document.getElementById('messagesList');
            const emptyState = document.getElementById('emptyMessages');
            
            loading.style.display = 'none';
            messagesList.style.display = 'none';
            emptyState.style.display = 'block';
        }
        
        // Focus message form
        function focusMessageForm() {
            document.getElementById('MessageTitle').focus();
            document.querySelector('.compose-card').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Refresh messages
        async function refreshMessages() {
            const refreshBtn = document.getElementById('refreshMessagesBtn');
            const icon = refreshBtn.querySelector('i');
            
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            try {
                await loadMessagesFromFirebase();
                showNotification('✅ Messages refreshed!', 'success');
            } catch (error) {
                showNotification('❌ Error refreshing messages', 'error');
            } finally {
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            }
        }
        
        // Animate messages
        function animateMessages() {
            const messageItems = document.querySelectorAll('.message-item');
            messageItems.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    item.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, index * 50);
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 300px;
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (messagesListener) {
                messagesListener();
            }
        });
        
        // Initialize everything when Firebase is ready
        waitForMessagesFirebase(function() {
            console.log('✅ Firebase ready for messages');
            setupMessages();
            console.log('✅ Messages setup complete');
        });
        
        console.log('💬 Messages script loaded');
    </script>
}@* email *@