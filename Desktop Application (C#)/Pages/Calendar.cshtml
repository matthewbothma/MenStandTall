@page
@model Wilproject.Pages.CalendarModel
@{
    ViewData["Title"] = "Calendar";
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/calendar.css" asp-append-version="true" />

<!-- Calendar Header -->
<div class="calendar-header">
    <div class="calendar-header-content">
        <h1 class="calendar-title"><i class="fas fa-calendar-alt"></i> Company Calendar</h1>
        <p class="calendar-subtitle">🌐 Viewing all team events - Collaborate and stay synchronized</p>
    </div>
</div>

<!-- Calendar Statistics -->
<div class="calendar-stats">
    <div class="calendar-stat-card events">
        <div class="stat-number" id="total-events">0</div>
        <div class="stat-label">Company Events</div>
    </div>
    <div class="calendar-stat-card today">
        <div class="stat-number" id="today-events">0</div>
        <div class="stat-label">Today</div>
    </div>
    <div class="calendar-stat-card upcoming">
        <div class="stat-number" id="upcoming-events">0</div>
        <div class="stat-label">This Week</div>
    </div>
    <div class="calendar-stat-card overdue">
        <div class="stat-number" id="my-events">0</div>
        <div class="stat-label">My Events</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <a href="#" class="quick-action" data-bs-toggle="modal" data-bs-target="#eventModal">
        <i class="fas fa-plus"></i>
        <span>Add Event</span>
    </a>
    <a href="#" class="quick-action" onclick="goToToday()">
        <i class="fas fa-calendar-day"></i>
        <span>Go to Today</span>
    </a>
    <a href="#" class="quick-action" onclick="toggleView()">
        <i class="fas fa-th"></i>
        <span>Change View</span>
    </a>
    <a href="#" class="quick-action" onclick="refreshCalendar()">
        <i class="fas fa-sync-alt"></i>
        <span>Refresh</span>
    </a>
</div>

<!-- Loading State -->
<div class="loading-calendar" id="loadingCalendar">
    <div class="text-center py-5">
        <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
        <h5>Loading Company Calendar...</h5>
        <p class="text-muted">Fetching all team events...</p>
    </div>
</div>

<!-- Calendar Container -->
<div class="calendar-container" id="calendarContainer" style="display: none;">
    <div class="calendar-wrapper">
        <div id="calendar"></div>
    </div>
</div>

<!-- Empty State -->
<div class="empty-calendar" id="emptyCalendar" style="display: none;">
    <div class="text-center py-5">
        <div class="empty-icon">
            <i class="fas fa-calendar-plus"></i>
        </div>
        <h4>No Events Scheduled</h4>
        <p>Be the first to add an event to the company calendar!</p>
        <button class="btn-modern-calendar btn-add-event" data-bs-toggle="modal" data-bs-target="#eventModal">
            <i class="fas fa-plus"></i> Add Your First Event
        </button>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade modal-modern" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header add-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Add New Event
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-floating">
                        <input type="text" id="eventTitle" class="form-control" placeholder="Enter event title..." required />
                        <label for="eventTitle"><i class="fas fa-heading"></i> Event Title</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea id="eventDescription" class="form-control" placeholder="Event description..." style="height: 100px"></textarea>
                        <label for="eventDescription"><i class="fas fa-align-left"></i> Description (Optional)</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="datetime-local" id="eventStart" class="form-control" required />
                                <label for="eventStart"><i class="fas fa-play"></i> Start Date & Time</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="datetime-local" id="eventEnd" class="form-control" />
                                <label for="eventEnd"><i class="fas fa-stop"></i> End Date & Time</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select id="eventCategory" class="form-control">
                                    <option value="meeting">Meeting</option>
                                    <option value="project">Project</option>
                                    <option value="personal">Personal</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="other">Other</option>
                                </select>
                                <label for="eventCategory"><i class="fas fa-tags"></i> Category</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select id="eventPriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium" selected>Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                                <label for="eventPriority"><i class="fas fa-exclamation-circle"></i> Priority</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="allDayEvent">
                        <label class="form-check-label" for="allDayEvent">
                            All Day Event
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-modern-calendar btn-add-event" id="saveEventBtn">
                    <i class="fas fa-save"></i> Add Event
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade modal-modern" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header edit-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i>
                    <span id="editModalTitle">Edit Event</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <input type="hidden" id="editEventId">
                    
                    <!-- Event Owner Info Badge -->
                    <div id="eventOwnerBadge" style="display: none; margin-bottom: 1rem;">
                        <div class="alert alert-info" style="margin-bottom: 1rem;">
                            <i class="fas fa-user"></i> <strong>Created by:</strong> <span id="eventOwnerName"></span>
                        </div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="text" id="editEventTitle" class="form-control" required />
                        <label for="editEventTitle"><i class="fas fa-heading"></i> Event Title</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea id="editEventDescription" class="form-control" placeholder="Event description..." style="height: 100px"></textarea>
                        <label for="editEventDescription"><i class="fas fa-align-left"></i> Description</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="datetime-local" id="editEventStart" class="form-control" required />
                                <label for="editEventStart"><i class="fas fa-play"></i> Start Date & Time</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="datetime-local" id="editEventEnd" class="form-control" />
                                <label for="editEventEnd"><i class="fas fa-stop"></i> End Date & Time</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select id="editEventCategory" class="form-control">
                                    <option value="meeting">Meeting</option>
                                    <option value="project">Project</option>
                                    <option value="personal">Personal</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="other">Other</option>
                                </select>
                                <label for="editEventCategory"><i class="fas fa-tags"></i> Category</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select id="editEventPriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                                <label for="editEventPriority"><i class="fas fa-exclamation-circle"></i> Priority</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-modern-calendar btn-delete-event" id="deleteFromEditBtn" style="display: none;">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button type="button" class="btn-modern-calendar btn-edit-event" id="updateEventBtn" style="display: none;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        console.log('📅 Universal Calendar script starting...');
        
        var calendar = null;
        var selectedInfo = null;
        var selectedEvent = null;
        var currentUser = null;
        var db = null;
        var events = [];
        
        // Wait for global Firebase to be ready
        function waitForCalendarFirebase(callback) {
            if (window.firebaseAuth && window.firebaseDB) {
                callback();
            } else {
                setTimeout(function() { waitForCalendarFirebase(callback); }, 100);
            }
        }
        
        // Setup calendar-specific functionality
        function setupCalendar() {
            console.log('📅 Setting up universal company calendar');
            
            if (!window.firebaseAuth || !window.firebaseDB) {
                console.error('❌ Firebase not available in calendar');
                return;
            }
            
            db = window.firebaseDB;
            
            // Authentication check for calendar
            window.firebaseAuth.onAuthStateChanged(function(user) {
                if (!user) {
                    console.log('❌ No user in calendar, redirecting');
                    window.location.href = '/';
                } else {
                    currentUser = user;
                    console.log('✅ Calendar user authenticated:', user.email);
                    loadEventsFromFirebase();
                }
            });
        }
        
        // Load ALL events from Firebase (UNIVERSAL VIEW)
        async function loadEventsFromFirebase() {
            if (!db || !currentUser) return;
            
            showLoadingState(true);
            
            try {
                console.log('📅 Loading ALL company events from Firebase...');
                
                // Load ALL events without user filter for universal calendar
                let eventsSnapshot;
                try {
                    console.log('📅 Attempting to load all company events...');
                    eventsSnapshot = await db.collection('events').get();
                    console.log('✅ Successfully loaded all company events');
                } catch (permissionError) {
                    console.log('📅 Company-wide access denied, loading user events only:', permissionError.message);
                    // Fallback to user-specific events if permissions don't allow company-wide access
                    eventsSnapshot = await db.collection('events')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    showNotification('ℹ️ Showing your events only. Contact admin for company-wide access.', 'info');
                }
                
                events = eventsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort events by start date on the client side
                events.sort((a, b) => {
                    const dateA = new Date(a.start);
                    const dateB = new Date(b.start);
                    return dateA - dateB;
                });
                
                console.log('✅ Events loaded and sorted:', events.length);
                console.log('📅 Event ownership breakdown:', events.map(e => ({
                    title: e.title,
                    author: e.authorName || e.authorEmail || 'Unknown',
                    isMine: e.userId === currentUser.uid
                })));
                
                if (events.length === 0) {
                    // Show empty calendar instead of empty state so users can still add events
                    initializeCalendar();
                } else {
                    initializeCalendar();
                }
                
                updateCalendarStats();
                
            } catch (error) {
                console.error('❌ Error loading events:', error);
                
                // Show empty state if there's an error
                showEmptyState();
                
                // Show user-friendly error message only for critical errors
                if (error.code === 'failed-precondition') {
                    // REMOVED: Info notification about simple mode
                } else if (error.code === 'permission-denied') {
                    showNotification('⚠️ Limited calendar access. You can view and edit only your events.', 'warning');
                }
            } finally {
                showLoadingState(false);
            }
        }
        
        // Initialize FullCalendar
        function initializeCalendar() {
            console.log('📅 Initializing FullCalendar with universal events');
            
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                console.error('❌ Calendar element not found');
                return;
            }
            
            // Show calendar container
            document.getElementById('calendarContainer').style.display = 'block';
            document.getElementById('emptyCalendar').style.display = 'none';

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                selectable: true,
                editable: true,
                dayMaxEvents: true,
                height: 'auto',
                // Add time format configuration for proper AM/PM display
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: 'short',
                    hour12: true
                },
                slotLabelFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: 'short',
                    hour12: true
                },
                events: events.map(event => {
                    const isMyEvent = event.userId === currentUser.uid;
                    var atSymbol = String.fromCharCode(64);
                    
                    // Get author name with better fallback logic
                    let authorName = 'Team Member';
                    if (event.authorName) {
                        authorName = event.authorName;
                    } else if (event.authorEmail) {
                        var emailParts = event.authorEmail.split(atSymbol);
                        authorName = emailParts[0];
                    }
                    
                    return {
                        id: event.id,
                        title: isMyEvent ? `${event.title}` : `${event.title} (${authorName})`,
                        start: event.start,
                        end: event.end,
                        allDay: event.allDay || false,
                        backgroundColor: getCategoryColor(event.category),
                        borderColor: isMyEvent ? '#ff6b35' : getCategoryColor(event.category),
                        borderWidth: isMyEvent ? 3 : 1,
                        extendedProps: {
                            description: event.description,
                            category: event.category,
                            priority: event.priority,
                            userId: event.userId,
                            authorName: authorName,
                            authorEmail: event.authorEmail,
                            isMyEvent: isMyEvent
                        }
                    };
                }),
                select: function (info) {
                    selectedInfo = info;
                    
                    // Pre-fill start and end times
                    const start = new Date(info.start);
                    const end = new Date(info.end || info.start);
                    
                    // If it's an all-day selection, set reasonable times
                    if (info.allDay) {
                        start.setHours(9, 0, 0, 0);
                        end.setHours(10, 0, 0, 0);
                    }
                    
                    document.getElementById('eventStart').value = formatDateTimeLocal(start);
                    document.getElementById('eventEnd').value = formatDateTimeLocal(end);
                    document.getElementById('allDayEvent').checked = info.allDay;
                    
                    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                    modal.show();
                },
                eventClick: function (info) {
                    selectedEvent = info.event;
                    const eventData = events.find(e => e.id === info.event.id);
                    
                    if (eventData) {
                        const isMyEvent = eventData.userId === currentUser.uid;
                        
                        // Get author name with better fallback logic
                        var atSymbol = String.fromCharCode(64);
                        let authorName = 'Team Member';
                        if (eventData.authorName) {
                            authorName = eventData.authorName;
                        } else if (eventData.authorEmail) {
                            var emailParts = eventData.authorEmail.split(atSymbol);
                            authorName = emailParts[0];
                        }
                        
                        // Update modal title and show ownership
                        const modalTitle = document.getElementById('editModalTitle');
                        const ownerBadge = document.getElementById('eventOwnerBadge');
                        const ownerName = document.getElementById('eventOwnerName');
                        
                        if (isMyEvent) {
                            modalTitle.textContent = 'Edit Your Event';
                            ownerBadge.style.display = 'none';
                        } else {
                            modalTitle.textContent = 'View Team Event';
                            ownerBadge.style.display = 'block';
                            ownerName.textContent = authorName;
                        }
                        
                        // Populate form
                        document.getElementById('editEventId').value = eventData.id;
                        document.getElementById('editEventTitle').value = eventData.title;
                        document.getElementById('editEventDescription').value = eventData.description || '';
                        document.getElementById('editEventStart').value = formatDateTimeLocal(new Date(eventData.start));
                        document.getElementById('editEventEnd').value = eventData.end ? formatDateTimeLocal(new Date(eventData.end)) : '';
                        document.getElementById('editEventCategory').value = eventData.category || 'other';
                        document.getElementById('editEventPriority').value = eventData.priority || 'medium';
                        
                        // Show/hide edit/delete buttons based on ownership
                        const updateBtn = document.getElementById('updateEventBtn');
                        const deleteBtn = document.getElementById('deleteFromEditBtn');
                        
                        if (isMyEvent) {
                            // User owns this event - can edit and delete
                            updateBtn.style.display = 'inline-block';
                            deleteBtn.style.display = 'inline-block';
                            
                            // Enable form fields
                            document.getElementById('editEventTitle').disabled = false;
                            document.getElementById('editEventDescription').disabled = false;
                            document.getElementById('editEventStart').disabled = false;
                            document.getElementById('editEventEnd').disabled = false;
                            document.getElementById('editEventCategory').disabled = false;
                            document.getElementById('editEventPriority').disabled = false;
                        } else {
                            // Team event - view only
                            updateBtn.style.display = 'none';
                            deleteBtn.style.display = 'none';
                            
                            // Disable form fields (read-only)
                            document.getElementById('editEventTitle').disabled = true;
                            document.getElementById('editEventDescription').disabled = true;
                            document.getElementById('editEventStart').disabled = true;
                            document.getElementById('editEventEnd').disabled = true;
                            document.getElementById('editEventCategory').disabled = true;
                            document.getElementById('editEventPriority').disabled = true;
                        }

                        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                        editModal.show();
                    }
                },
                eventDidMount: function(info) {
                    // Add priority indicator
                    const priority = info.event.extendedProps.priority;
                    const isMyEvent = info.event.extendedProps.isMyEvent;
                    const authorName = info.event.extendedProps.authorName || 'Team Member';
                    
                    if (priority === 'high') {
                        info.el.style.border = '2px solid #ef4444';
                    }
                    
                    // Add ownership indicator
                    if (isMyEvent) {
                        info.el.style.fontWeight = 'bold';
                        info.el.title = '✓ Your Event - Click to edit';
                    } else {
                        info.el.title = `Team Event by ${authorName} - Click to view`;
                    }
                }
            });
            
            calendar.render();
            setupEventHandlers();
            console.log('✅ Universal FullCalendar initialized');
        }
        
        // Save event
        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const startTime = document.getElementById('eventStart').value;
            const endTime = document.getElementById('eventEnd').value;
            const category = document.getElementById('eventCategory').value;
            const priority = document.getElementById('eventPriority').value;
            const allDay = document.getElementById('allDayEvent').checked;
            
            if (!title || !startTime) {
                showNotification('⚠️ Please fill in the required fields', 'warning');
                return;
            }
            
            // Validate dates
            const startDate = new Date(startTime);
            const endDate = endTime ? new Date(endTime) : startDate;
            
            if (endTime && endDate < startDate) {
                showNotification('⚠️ End time cannot be before start time', 'warning');
                return;
            }
            
            // Get clean user name
            const userName = currentUser.displayName || (currentUser.email ? currentUser.email.split(String.fromCharCode(64))[0] : 'User');
            var atSymbol = String.fromCharCode(64);
            var hasAtSymbol = userName.indexOf(atSymbol) > -1;
            const cleanUserName = hasAtSymbol ? userName.split(atSymbol)[0] : userName;
            
            const eventData = {
                title: title,
                description: description,
                start: startTime,
                end: endTime || startTime,
                allDay: allDay,
                category: category,
                priority: priority,
                userId: currentUser.uid,
                authorName: cleanUserName,
                authorEmail: currentUser.email,
                createdAt: new Date().toISOString(),
                // Add timestamp for easier querying without composite index
                startTimestamp: startDate.getTime(),
                endTimestamp: endDate.getTime()
            };
            
            try {
                console.log('📅 Saving event to company calendar:', eventData);
                
                const docRef = await db.collection('events').add(eventData);
                console.log('✅ Event saved to company calendar with ID:', docRef.id);
                
                showNotification('✅ Event added to company calendar!', 'success');
                
                // Clear form
                document.getElementById('eventForm').reset();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
                modal.hide();
                
                // Reload events
                await loadEventsFromFirebase();
                
                // Dispatch event for dashboard sync
                const eventSavedEvent = new CustomEvent('calendarEventSaved', {
                    detail: {
                        eventId: docRef.id,
                        eventData: eventData,
                        timestamp: new Date().toISOString()
                    }
                });
                window.dispatchEvent(eventSavedEvent);
                
                console.log('📡 Calendar event saved event dispatched for dashboard sync');
                
            } catch (error) {
                console.error('❌ Error saving event:', error);
                showNotification('❌ Error saving event: ' + error.message, 'error');
            }
        }
        
        // Update event (only for owned events)
        async function updateEvent() {
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('editEventTitle').value.trim();
            const description = document.getElementById('editEventDescription').value.trim();
            const startTime = document.getElementById('editEventStart').value;
            const endTime = document.getElementById('editEventEnd').value;
            const category = document.getElementById('editEventCategory').value;
            const priority = document.getElementById('editEventPriority').value;
            
            if (!title || !startTime || !eventId) {
                showNotification('⚠️ Please fill in the required fields', 'warning');
                return;
            }
            
            // Verify ownership
            const event = events.find(e => e.id === eventId);
            if (!event || event.userId !== currentUser.uid) {
                showNotification('❌ You can only edit your own events', 'error');
                return;
            }
            
            const eventData = {
                title: title,
                description: description,
                start: startTime,
                end: endTime || startTime,
                category: category,
                priority: priority,
                updatedAt: new Date().toISOString()
            };
            
            try {
                await db.collection('events').doc(eventId).update(eventData);
                console.log('✅ Event updated:', eventId);
                
                showNotification('✅ Your event updated successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                
                // Reload events
                await loadEventsFromFirebase();
                
                // Dispatch event for dashboard sync
                const eventUpdatedEvent = new CustomEvent('calendarEventUpdated', {
                    detail: {
                        eventId: eventId,
                        eventData: eventData,
                        timestamp: new Date().toISOString()
                    }
                });
                window.dispatchEvent(eventUpdatedEvent);
                
                console.log('📡 Calendar event updated event dispatched for dashboard sync');
                
            } catch (error) {
                console.error('Error updating event:', error);
                showNotification('❌ Error updating event', 'error');
            }
        }
        
        // Delete event (only for owned events)
        async function deleteEvent() {
            const eventId = document.getElementById('editEventId').value;
            
            if (!eventId) return;
            
            // Verify ownership
            const event = events.find(e => e.id === eventId);
            if (!event || event.userId !== currentUser.uid) {
                showNotification('❌ You can only delete your own events', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            try {
                await db.collection('events').doc(eventId).delete();
                console.log('✅ Event deleted:', eventId);
                
                showNotification('✅ Your event deleted successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                
                // Reload events
                await loadEventsFromFirebase();
                
                // Dispatch event for dashboard sync
                const eventDeletedEvent = new CustomEvent('calendarEventDeleted', {
                    detail: {
                        eventId: eventId,
                        timestamp: new Date().toISOString()
                    }
                });
                window.dispatchEvent(eventDeletedEvent);
                
                console.log('📡 Calendar event deleted event dispatched for dashboard sync');
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showNotification('❌ Error deleting event', 'error');
            }
        }
        
        // Setup event handlers
        function setupEventHandlers() {
            // Save Event
            document.getElementById('saveEventBtn').addEventListener('click', saveEvent);
            
            // Update Event
            document.getElementById('updateEventBtn').addEventListener('click', updateEvent);
            
            // Delete Event
            document.getElementById('deleteFromEditBtn').addEventListener('click', deleteEvent);
            
            // All day event toggle
            document.getElementById('allDayEvent').addEventListener('change', function() {
                const startInput = document.getElementById('eventStart');
                const endInput = document.getElementById('eventEnd');
                
                if (this.checked) {
                    // Convert to date only
                    if (startInput.value) {
                        startInput.type = 'date';
                        startInput.value = startInput.value.split('T')[0];
                    }
                    if (endInput.value) {
                        endInput.type = 'date';
                        endInput.value = endInput.value.split('T')[0];
                    }
                } else {
                    // Convert back to datetime
                    startInput.type = 'datetime-local';
                    endInput.type = 'datetime-local';
                }
            });
        }
        
        // Utility functions
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function getCategoryColor(category) {
            const colors = {
                'meeting': '#667eea',
                'project': '#4facfe',
                'deadline': '#f093fb',
                'personal': '#43e97b',
                'other': '#64748b'
            };
            return colors[category] || colors.other;
        }
        
        // Update calendar statistics
        function updateCalendarStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let todayEvents = 0;
            let upcomingEvents = 0;
            let myEvents = 0;
            
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            events.forEach(event => {
                const eventDate = new Date(event.start);
                eventDate.setHours(0, 0, 0, 0);
                
                // Today's events
                if (eventDate.getTime() === today.getTime()) {
                    todayEvents++;
                }
                
                // This week's events
                if (eventDate >= today && eventDate <= nextWeek) {
                    upcomingEvents++;
                }
                
                // My events
                if (event.userId === currentUser.uid) {
                    myEvents++;
                }
            });
            
            document.getElementById('total-events').textContent = events.length;
            document.getElementById('today-events').textContent = todayEvents;
            document.getElementById('upcoming-events').textContent = upcomingEvents;
            document.getElementById('my-events').textContent = myEvents;
        }
        
        // Quick action functions
        function goToToday() {
            if (calendar) {
                calendar.today();
            }
        }
        
        let currentView = 'dayGridMonth';
        function toggleView() {
            if (!calendar) return;
            
            const views = ['dayGridMonth', 'timeGridWeek', 'timeGridDay'];
            const currentIndex = views.indexOf(currentView);
            const nextIndex = (currentIndex + 1) % views.length;
            currentView = views[nextIndex];
            
            calendar.changeView(currentView);
            
            const viewNames = {
                'dayGridMonth': 'Month View',
                'timeGridWeek': 'Week View',
                'timeGridDay': 'Day View'
            };
            
            showNotification(`📅 Switched to ${viewNames[currentView]}`, 'info');
        }
        
        // Refresh calendar
        async function refreshCalendar() {
            showNotification('🔄 Refreshing company calendar...', 'info');
            await loadEventsFromFirebase();
        }
        
        // UI state functions
        function showLoadingState(show) {
            const loading = document.getElementById('loadingCalendar');
            const container = document.getElementById('calendarContainer');
            const empty = document.getElementById('emptyCalendar');
            
            if (show) {
                loading.style.display = 'block';
                container.style.display = 'none';
                empty.style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }
        
        function showEmptyState() {
            const loading = document.getElementById('loadingCalendar');
            const container = document.getElementById('calendarContainer');
            const empty = document.getElementById('emptyCalendar');
            
            loading.style.display = 'none';
            container.style.display = 'none';
            empty.style.display = 'block';
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 300px;
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Initialize everything when Firebase is ready
        waitForCalendarFirebase(function() {
            console.log('✅ Firebase ready for universal calendar');
            setupCalendar();
            console.log('✅ Universal calendar setup complete');
        });
        
        console.log('📅 Universal Calendar script loaded');
    </script>
}}