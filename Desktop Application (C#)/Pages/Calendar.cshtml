@page
@model Wilgproject.Pages.CalendarModel
@{
    ViewData["Title"] = "Calendar";
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .calendar-container {
        margin: 20px 0;
    }

    #calendar {
        max-width: 900px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
    }

    .modal-header {
        color: white;
    }

    .add-header {
        background-color: #198754; /* green */
    }

    .edit-header {
        background-color: #0d6efd; /* blue */
    }

    .delete-header {
        background-color: #dc3545; /* red */
    }
    
    /* Ensure logout button has consistent red styling */
    #sidebar-logout-btn {
        background: #dc3545 !important;
        border: 1px solid #dc3545 !important;
        color: white !important;
        font-weight: 500 !important;
        width: 100% !important;
    }
    
    #sidebar-logout-btn:hover {
        background: #c82333 !important;
        border-color: #c82333 !important;
        color: white !important;
    }
    
    /* Override any Bootstrap conflicts */
    .sidebar .logout-btn {
        background: #dc3545 !important;
        border: 1px solid #dc3545 !important;
        color: white !important;
    }
    
    .sidebar .logout-btn:hover {
        background: #c82333 !important;
        border-color: #c82333 !important;
        color: white !important;
    }
</style>

<div class="calendar-container">
    <h2 class="text-center mb-4">Calendar</h2>
    <div id="calendar"></div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header add-header">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="eventTitle" class="form-control" placeholder="Enter event title..." />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" id="saveEventBtn">Add Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header edit-header">
                <h5 class="modal-title">Edit Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editEventTitle" class="form-control" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="deleteFromEditBtn">Delete</button>
                <button class="btn btn-primary" id="updateEventBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header delete-header">
                <h5 class="modal-title">Delete Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this event?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        console.log('📅 Calendar script starting...');
        
        // Wait for global Firebase to be ready
        function waitForCalendarFirebase(callback) {
            if (window.firebaseAuth) {
                callback();
            } else {
                setTimeout(function() { waitForCalendarFirebase(callback); }, 100);
            }
        }
        
        // Setup calendar-specific functionality
        function setupCalendar() {
            console.log('📅 Setting up calendar');
            
            if (!window.firebaseAuth) {
                console.error('❌ Firebase auth not available in calendar');
                return;
            }
            
            // Authentication check for calendar
            window.firebaseAuth.onAuthStateChanged(function(user) {
                if (!user) {
                    console.log('❌ No user in calendar, redirecting');
                    window.location.href = '/';
                } else {
                    console.log('✅ Calendar user authenticated:', user.email);
                    initializeCalendar();
                    
                    // Ensure logout button styling after auth
                    setTimeout(function() {
                        var logoutBtn = document.getElementById('sidebar-logout-btn');
                        if (logoutBtn) {
                            logoutBtn.style.background = '#dc3545';
                            logoutBtn.style.borderColor = '#dc3545';
                            logoutBtn.style.color = 'white';
                            console.log('✅ Logout button styling applied');
                        }
                    }, 1000);
                }
            });
        }
        
        // Initialize FullCalendar
        function initializeCalendar() {
            console.log('📅 Initializing FullCalendar');
            
            var calendarEl = document.getElementById('calendar');
            var selectedInfo = null;
            var selectedEvent = null;

            if (!calendarEl) {
                console.error('❌ Calendar element not found');
                return;
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: '2025-08-01',
                selectable: true,
                editable: true,
                events: [
                    { title: 'Event 1', start: '2025-08-01' },
                    { title: 'Event 2', start: '2025-08-05', end: '2025-08-07' }
                ],
                select: function (info) {
                    selectedInfo = info;
                    var myModal = new bootstrap.Modal(document.getElementById('eventModal'));
                    myModal.show();
                },
                eventClick: function (info) {
                    selectedEvent = info.event;
                    document.getElementById("editEventTitle").value = selectedEvent.title;
                    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
                    editModal.show();
                }
            });
            
            calendar.render();
            console.log('✅ FullCalendar initialized');

            // Event handlers
            setupEventHandlers(calendar, selectedInfo, selectedEvent);
        }
        
        // Setup event handlers
        function setupEventHandlers(calendar, selectedInfo, selectedEvent) {
            // Save Event
            document.getElementById("saveEventBtn").addEventListener("click", function () {
                var title = document.getElementById("eventTitle").value;
                if (title && selectedInfo) {
                    calendar.addEvent({
                        title: title,
                        start: selectedInfo.start,
                        end: selectedInfo.end,
                        allDay: selectedInfo.allDay
                    });
                }
                document.getElementById("eventTitle").value = "";
                selectedInfo = null;
                var modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
                modal.hide();
            });

            // Update Event
            document.getElementById("updateEventBtn").addEventListener("click", function () {
                var newTitle = document.getElementById("editEventTitle").value;
                if (selectedEvent && newTitle) {
                    selectedEvent.setProp("title", newTitle);
                }
                selectedEvent = null;
                var modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
            });

            // Delete from Edit Modal
            document.getElementById("deleteFromEditBtn").addEventListener("click", function () {
                var editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                editModal.hide();
                var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });

            // Confirm Delete
            document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
                if (selectedEvent) {
                    selectedEvent.remove();
                    selectedEvent = null;
                }
                var modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            });
        }
        
        // Initialize everything when Firebase is ready
        waitForCalendarFirebase(function() {
            console.log('✅ Firebase ready for calendar');
            setupCalendar();
            console.log('✅ Calendar setup complete');
        });
        
        console.log('📅 Calendar script loaded');
    </script>
}