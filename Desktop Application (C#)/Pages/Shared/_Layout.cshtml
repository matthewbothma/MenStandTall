<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Men Stand Tall</title>
    
    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/modern-layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/Wilproject.styles.css" asp-append-version="true" />
</head>
<body>
    <!-- Modern Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-users"></i> Men Stand Tall</h3>
            <p>Project Management Portal</p>
        </div>
        
        <!-- User Info Card -->
        <div id="sidebar-user-info" class="user-info">
            <div class="user-avatar" id="user-avatar">MT</div>
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-role">Project Manager</div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-section">
            <div class="nav-title">Main</div>
            <a href="@Url.Page("/Dashboard")" class="nav-link" data-page="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="@Url.Page("/Projects")" class="nav-link" data-page="projects">
                <i class="fas fa-project-diagram"></i>
                <span>Projects</span>
                <span class="notification-badge">3</span>
            </a>
            <a href="@Url.Page("/Tasks")" class="nav-link" data-page="tasks">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Tools</div>
            <a href="@Url.Page("/Calendar")" class="nav-link" data-page="calendar">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
            <a href="@Url.Page("/Messages")" class="nav-link" data-page="messages">
                <i class="fas fa-comments"></i>
                <span>Messages</span>
            </a>
            <a href="@Url.Page("/Report")" class="nav-link" data-page="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
        </div>
        
        <!-- Logout Section -->
        <div class="logout-section">
            <button class="logout-btn" id="sidebar-logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <main role="main">
            @RenderBody()
        </main>
    </div>

    <!-- Mobile Menu Toggle (Hidden by default) -->
    <button class="mobile-menu-toggle d-md-none" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <!-- Global Firebase Configuration -->
    <script src="~/js/firebase-global.js"></script>
    
    <script>
        console.log('🎯 Modern layout script starting...');
        
        var currentUser = null;
        
        // Set active navigation link
        function setActiveNavLink() {
            const path = window.location.pathname.toLowerCase();
            const links = document.querySelectorAll('.nav-link');
            
            links.forEach(link => {
                link.classList.remove('active');
                const page = link.getAttribute('data-page');
                if (path.includes(page) || (path === '/' && page === 'dashboard')) {
                    link.classList.add('active');
                }
            });
        }
        
        // Check if current page is Dashboard
        function isDashboardPage() {
            var path = window.location.pathname.toLowerCase();
            return path === '/dashboard' || path === '/';
        }
        
        // Wait for global Firebase to be ready
        function waitForFirebase(callback) {
            if (window.firebaseAuth) {
                callback();
            } else {
                setTimeout(function() { waitForFirebase(callback); }, 100);
            }
        }
        
        // Setup authentication monitoring
        function setupAuth() {
            console.log('🔐 Setting up authentication monitoring');
            
            if (!window.firebaseAuth) {
                console.error('❌ Firebase auth not available');
                return;
            }
            
            window.firebaseAuth.onAuthStateChanged(function(user) {
                console.log('🔄 Auth state changed:', user ? user.email : 'No user');
                currentUser = user;
                
                if (!user && window.location.pathname !== '/') {
                    console.log('❌ No user, redirecting to login');
                    window.location.href = '/';
                } else if (user) {
                    updateUserDisplay(user);
                    // Show user info only on dashboard
                    if (isDashboardPage()) {
                        showUserInfo();
                    }
                }
            });
        }
        
        // Update user display in sidebar
        function updateUserDisplay(user) {
            if (user) {
                const displayName = user.displayName || user.email || 'User';
                const emailSymbol = String.fromCharCode(64);
                const atIndex = displayName.indexOf(emailSymbol);
                const name = atIndex > -1 ? displayName.substring(0, atIndex) : displayName;
                
                // Update user name
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) {
                    userNameEl.textContent = name;
                }
                
                // Update avatar initials
                const avatarEl = document.getElementById('user-avatar');
                if (avatarEl) {
                    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    avatarEl.textContent = initials;
                }
                
                console.log('✅ User display updated for:', name);
            }
        }
        
        // Show user info card
        function showUserInfo() {
            const userInfo = document.getElementById('sidebar-user-info');
            if (userInfo) {
                userInfo.classList.add('show');
            }
        }
        
        // Hide user info card
        function hideUserInfo() {
            const userInfo = document.getElementById('sidebar-user-info');
            if (userInfo) {
                userInfo.classList.remove('show');
            }
        }
        
        // Setup logout button
        function setupLogout() {
            console.log('🚪 Setting up logout button');
            
            var logoutBtn = document.getElementById('sidebar-logout-btn');
            
            if (!logoutBtn) {
                console.error('❌ Logout button not found!');
                return;
            }
            
            logoutBtn.onclick = function() {
                console.log('🚪 Logout button clicked!');
                
                // Add loading state
                const btnText = logoutBtn.querySelector('span');
                const originalText = btnText.textContent;
                btnText.innerHTML = '<div class="loading-spinner"></div>';
                
                // Use the global logout function
                if (window.globalLogout) {
                    window.globalLogout();
                } else {
                    console.error('❌ Global logout function not available');
                    // Fallback
                    window.location.href = '/';
                }
                
                return false;
            };
            
            console.log('✅ Logout button setup complete');
        }
        
        // Mobile menu toggle
        function setupMobileMenu() {
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && 
                        !sidebar.contains(e.target) && 
                        !toggleBtn.contains(e.target)) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            }
        }
        
        // Initialize everything when Firebase is ready
        waitForFirebase(function() {
            console.log('✅ Firebase is ready, setting up modern layout functionality');
            setupAuth();
            setupLogout();
            setupMobileMenu();
            setActiveNavLink();
            
            // Hide user info on non-dashboard pages
            if (!isDashboardPage()) {
                hideUserInfo();
            }
            
            console.log('✅ Modern layout setup complete');
        });
        
        // Set active nav on page load
        document.addEventListener('DOMContentLoaded', function() {
            setActiveNavLink();
        });
        
        console.log('🎯 Modern layout script loaded');
    </script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>